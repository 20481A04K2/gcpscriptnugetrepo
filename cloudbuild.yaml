steps:
  # Step 1: Download GitHub repo ZIP and extract it
  - name: 'gcr.io/cloud-builders/curl'
    id: 'Download GitHub Source'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Downloading GitHub source zip..."
        curl -L -o source.zip https://github.com/20481A04K2/gcpscriptnugetrepo/archive/refs/heads/main.zip
        unzip source.zip -d /workspace
        mv /workspace/gcpscriptnugetrepo-main /workspace/app

  # Step 2: Add BaGet NuGet source using secret API key
  - name: 'mcr.microsoft.com/dotnet/sdk:7.0'
    id: 'Add BaGet NuGet Source'
    entrypoint: bash
    secretEnv: ['BAGET_API_KEY']
    args:
      - -c
      - |
        echo "Adding BaGet NuGet source..."
        dotnet nuget add source https://baget-service-880653953247.asia-south1.run.app/v3/index.json \
          --name baget \
          --username anyuser \
          --password "$BAGET_API_KEY" \
          --store-password-in-clear-text

  # Step 3: Restore packages using BaGet source
  - name: 'mcr.microsoft.com/dotnet/sdk:7.0'
    id: 'Restore Packages from BaGet'
    entrypoint: bash
    args:
      - -c
      - |
        cd /workspace/app
        echo "Restoring packages from BaGet..."
        dotnet restore MyApp.csproj --source baget

  # Step 4: Confirm .nupkg packages are downloaded
  - name: 'ubuntu'
    id: 'Verify Nupkg'
    entrypoint: bash
    args:
      - -c
      - |
        echo "Checking if nupkg files are cached locally..."
        find ~/.nuget/packages -name '*.nupkg' -exec du -h {} \; || echo "No nupkg files found."

  # Step 5: Build and Publish .NET App
  - name: 'mcr.microsoft.com/dotnet/sdk:7.0'
    id: 'Publish App'
    entrypoint: bash
    args:
      - -c
      - |
        cd /workspace/app
        dotnet publish MyApp.csproj -c Release -o dist
        echo "Contents of dist:"
        ls -lh dist

  # Step 6: Upload dist/ to GCS
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Upload to GCS'
    entrypoint: bash
    args:
      - -c
      - |
        echo "Uploading dist/ to GCS..."
        gsutil -m cp -r /workspace/app/dist/* gs://my-dotnet-packages/dist/

secrets:
- kmsKeyName: projects/onyx-antler-459216-j6/locations/global/keyRings/my-keyring/cryptoKeys/my-key
  secretEnv:
    BAGET_API_KEY: projects/onyx-antler-459216-j6/secrets/baget-api-key/versions/latest


options:
  logging: CLOUD_LOGGING_ONLY
